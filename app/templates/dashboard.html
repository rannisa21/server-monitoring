{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <h2>Dashboard</h2>
    <div class="header-actions">
        <span class="total-info" id="total-items">{{ total_items }} items</span>
        <span class="refresh-info" id="last-refresh-info">
            <span class="refresh-dot"></span>
            <span id="last-refresh-time">Loading...</span>
        </span>
        <!-- View Type Toggle Buttons -->
        <div class="view-toggle">
            <a href="{{ url_for('dashboard.dashboard', view='table', search=search_query, category=category_filter, status=status_filter, sort=sort_by, order=sort_order, **{'server_id': server_filter}) }}" 
               class="btn-view {% if view_type == 'table' %}active{% endif %}">📊 Table View</a>
            <a href="{{ url_for('dashboard.dashboard', view='card', search=search_query, category=category_filter, status=status_filter, sort=sort_by, order=sort_order, **{'server_id': server_filter}) }}" 
               class="btn-view {% if view_type == 'card' %}active{% endif %}">🗂️ Card View</a>
        </div>
        <button type="button" class="btn btn-success" onclick="openReportModal()">
            <span>📥</span> Download Report
        </button>
    </div>
</div>

<!-- Download Report Modal -->
<div id="reportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Download Report Excel</h3>
            <button type="button" class="modal-close" onclick="closeReportModal()">&times;</button>
        </div>
        <form action="{{ url_for('dashboard.download_report') }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="modal-body">
                <div class="form-group">
                    <label for="report_month">Bulan</label>
                    <select name="month" id="report_month" required>
                        <option value="">-- Pilih Bulan --</option>
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="report_year">Tahun</label>
                    <select name="year" id="report_year" required>
                        <option value="">-- Pilih Tahun --</option>
                        {% for y in range(2024, 2031) %}
                        <option value="{{ y }}">{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeReportModal()">Batal</button>
                <button type="submit" class="btn btn-primary">Download</button>
            </div>
        </form>
    </div>
</div>

<!-- Filter, Search, and Sort Section -->
<div class="dashboard-toolbar">
    <form method="get" action="{{ url_for('dashboard.dashboard') }}" class="filter-form" id="dashboardForm">
        <div class="filter-row">
            <!-- Search -->
            <div class="filter-item">
                <input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Search server, component, IP, OID...">
            </div>

            <!-- Server Filter (Multi-select Dropdown) -->
            <div class="filter-item">
                <div class="multi-select-wrapper">
                    <button type="button" class="multi-select-btn" onclick="toggleDropdown('serverDropdown')">
                        <span id="serverLabel">{% if server_filter %}{{ server_filter|length }} server(s){% else %}All Servers{% endif %}</span>
                        <span class="arrow">▼</span>
                    </button>
                    <div id="serverDropdown" class="multi-select-dropdown">
                        <label class="checkbox-item">
                            <input type="checkbox" id="selectAllServers" onchange="toggleAllServers(this)"> <strong>Select All</strong>
                        </label>
                        {% for server in servers %}
                        <label class="checkbox-item">
                            <input type="checkbox" name="server_id" value="{{ server.id }}" {% if server.id in server_filter %}checked{% endif %} onchange="updateServerLabel()"> {{ server.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="filter-item">
                <select name="category" id="category" onchange="this.form.submit()">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Status Filter -->
            <div class="filter-item">
                <select name="status" id="status" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="OK" {% if status_filter == 'OK' %}selected{% endif %}>OK</option>
                    <option value="Warning" {% if status_filter == 'Warning' %}selected{% endif %}>Warning</option>
                    <option value="Critical" {% if status_filter == 'Critical' %}selected{% endif %}>Critical</option>
                    <option value="no_data" {% if status_filter == 'no_data' %}selected{% endif %}>No Data</option>
                </select>
            </div>

            <!-- Sort -->
            <div class="filter-item sort-group">
                <select name="sort" id="sort" onchange="this.form.submit()">
                    <option value="server" {% if sort_by == 'server' %}selected{% endif %}>Server</option>
                    <option value="component" {% if sort_by == 'component' %}selected{% endif %}>Component</option>
                    <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Category</option>
                    <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
                    <option value="timestamp" {% if sort_by == 'timestamp' %}selected{% endif %}>Timestamp</option>
                </select>
                <select name="order" id="order" onchange="this.form.submit()">
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>↑ Asc</option>
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>↓ Desc</option>
                </select>
            </div>

            <!-- Actions -->
            <div class="filter-item filter-actions">
                <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                {% if search_query or server_filter or category_filter or status_filter %}
                <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-secondary btn-sm">Clear</a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

{% if error %}
<div class="flash flash-danger">{{ error }}</div>
{% endif %}

{% if view_type == 'table' %}
<!-- TABLE VIEW -->
<div class="dashboard-table-wrapper">
    <table class="data-table" id="dashboardTable">
        <thead>
            <tr>
                <th>Server</th>
                <th>Component</th>
                <th>Category</th>
                <th>OID</th>
                <th>Brand</th>
                <th>Value</th>
                <th>Timestamp</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in dashboard_data %}
            <tr class="{% if item.metric %}status-row-{{ item.metric.status|lower }}{% else %}status-row-unknown{% endif %}">
                <td><strong>{{ item.server.name }}</strong></td>
                <td>{{ item.component.name }}</td>
                <td><span class="category-badge {{ item.component.category }}">{{ item.component.category }}</span></td>
                <td><code>{{ item.component.oid }}</code></td>
                <td>{{ item.server.brand }}</td>
                <td>{{ item.metric.value if item.metric else '-' }}</td>
                <td>{{ item.metric.timestamp.strftime('%Y-%m-%d %H:%M:%S') if item.metric else '-' }}</td>
                            <td>
                    {% if item.metric %}
                    <span class="status-badge status-{{ item.metric.status|lower }}">{{ item.metric.status }}</span>
                    {% else %}
                    <span class="status-badge status-unknown">No Data</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" class="text-center">No data available</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% elif view_type == 'card' %}
<!-- CARD VIEW -->
<div class="dashboard-cards-wrapper">
    {% if card_data %}
        {% for server_id, card_item in card_data.items() %}
        <div class="server-card">
            <div class="card-header">
                <h3>{{ card_item.server.name }}</h3>
            </div>
            <div class="card-body">
                {% if card_item.components %}
                    <div class="components-list">
                        {% for component_item in card_item.components %}
                        <div class="component-item">
                            <div class="component-header">
                                <span class="component-name">{{ component_item.component.name }}</span>
                                <span class="status-badge status-{% if component_item.metric %}{{ component_item.metric.status|lower }}{% else %}unknown{% endif %}">
                                    {% if component_item.metric %}
                                        {% if component_item.metric.status == 'OK' %}🟢
                                        {% elif component_item.metric.status == 'Warning' %}🟡
                                        {% elif component_item.metric.status == 'Critical' %}🔴
                                        {% else %}?
                                        {% endif %}
                                    {% else %}—{% endif %}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-components">No components</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p>No data available</p>
        </div>
    {% endif %}
</div>

{% endif %}

<script>
// Dashboard Auto-Refresh Configuration
const REFRESH_INTERVAL = 1000; // 1sec
let refreshTimer = null;
let isRefreshing = false;

function toggleDropdown(id) {
    var dropdown = document.getElementById(id);
    dropdown.classList.toggle('show');
}

function toggleAllServers(checkbox) {
    var checkboxes = document.querySelectorAll('#serverDropdown input[name="server_id"]');
    checkboxes.forEach(function(cb) {
        cb.checked = checkbox.checked;
    });
    updateServerLabel();
}

function updateServerLabel() {
    var checkboxes = document.querySelectorAll('#serverDropdown input[name="server_id"]:checked');
    var label = document.getElementById('serverLabel');
    var selectAll = document.getElementById('selectAllServers');
    var total = document.querySelectorAll('#serverDropdown input[name="server_id"]').length;
    
    if (checkboxes.length === 0) {
        label.textContent = 'All Servers';
    } else if (checkboxes.length === total) {
        label.textContent = 'All Servers';
    } else {
        label.textContent = checkboxes.length + ' server(s)';
    }
    
    selectAll.checked = checkboxes.length === total;
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.multi-select-wrapper')) {
        document.querySelectorAll('.multi-select-dropdown').forEach(function(dropdown) {
            dropdown.classList.remove('show');
        });
    }
});

// Get current filter parameters from URL
function getCurrentFilters() {
    const params = new URLSearchParams(window.location.search);
    return {
        server_id: params.getAll('server_id'),
        category: params.get('category') || '',
        status: params.get('status') || '',
        search: params.get('search') || '',
        sort: params.get('sort') || 'server',
        order: params.get('order') || 'asc'
    };
}

// Build query string from filters
function buildQueryString(filters) {
    const params = new URLSearchParams();
    if (filters.server_id && filters.server_id.length > 0) {
        filters.server_id.forEach(id => params.append('server_id', id));
    }
    if (filters.category) params.append('category', filters.category);
    if (filters.status) params.append('status', filters.status);
    if (filters.search) params.append('search', filters.search);
    if (filters.sort) params.append('sort', filters.sort);
    if (filters.order) params.append('order', filters.order);
    return params.toString();
}

// Get status badge HTML
function getStatusBadge(status) {
    if (!status) {
        return '<span class="status-badge status-unknown">No Data</span>';
    }
    return `<span class="status-badge status-${status.toLowerCase()}">${status}</span>`;
}

// Get status emoji for card view
function getStatusEmoji(status) {
    if (!status) return '—';
    switch(status) {
        case 'OK': return '🟢';
        case 'Warning': return '🟡';
        case 'Critical': return '🔴';
        default: return '?';
    }
}

// Get row class based on status
function getRowClass(status) {
    if (!status) return 'status-row-unknown';
    return `status-row-${status.toLowerCase()}`;
}

// Update table view with new data
function updateTableView(data) {
    const tbody = document.querySelector('#dashboardTable tbody');
    if (!tbody) return;
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No data available</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(item => `
        <tr class="${getRowClass(item.metric_status)}">
            <td><strong>${escapeHtml(item.server_name)}</strong></td>
            <td>${escapeHtml(item.component_name)}</td>
            <td><span class="category-badge ${item.category}">${escapeHtml(item.category)}</span></td>
            <td><code>${escapeHtml(item.component_oid)}</code></td>
            <td>${escapeHtml(item.server_brand || '')}</td>
            <td>${item.metric_value !== null ? escapeHtml(item.metric_value) : '-'}</td>
            <td>${item.metric_timestamp || '-'}</td>
            <td>${getStatusBadge(item.metric_status)}</td>
        </tr>
    `).join('');
}

// Update card view with new data
function updateCardView(data) {
    const wrapper = document.querySelector('.dashboard-cards-wrapper');
    if (!wrapper) return;
    
    if (data.length === 0) {
        wrapper.innerHTML = '<div class="empty-state"><p>No data available</p></div>';
        return;
    }
    
    // Group data by server
    const cardData = {};
    data.forEach(item => {
        if (!cardData[item.server_id]) {
            cardData[item.server_id] = {
                server_name: item.server_name,
                components: []
            };
        }
        cardData[item.server_id].components.push(item);
    });
    
    wrapper.innerHTML = Object.values(cardData).map(card => `
        <div class="server-card">
            <div class="card-header">
                <h3>${escapeHtml(card.server_name)}</h3>
            </div>
            <div class="card-body">
                <div class="components-list">
                    ${card.components.map(comp => `
                        <div class="component-item">
                            <div class="component-header">
                                <span class="component-name">${escapeHtml(comp.component_name)}</span>
                                <span class="status-badge status-${comp.metric_status ? comp.metric_status.toLowerCase() : 'unknown'}">
                                    ${getStatusEmoji(comp.metric_status)}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `).join('');
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Update refresh time display
function updateRefreshTimeDisplay() {
    const refreshTime = document.getElementById('last-refresh-time');
    if (refreshTime) {
        const now = new Date();
        refreshTime.textContent = 'Updated: ' + now.toLocaleTimeString('id-ID');
    }
}

// Show loading indicator
function showLoadingIndicator(show) {
    const refreshInfo = document.getElementById('last-refresh-info');
    if (refreshInfo) {
        if (show) {
            refreshInfo.classList.add('refreshing');
        } else {
            refreshInfo.classList.remove('refreshing');
        }
    }
}

// Fetch and update dashboard data
async function refreshDashboardData() {
    if (isRefreshing) return;
    isRefreshing = true;
    showLoadingIndicator(true);
    
    try {
        const filters = getCurrentFilters();
        const queryString = buildQueryString(filters);
        const url = `{{ url_for('dashboard.api_dashboard_data') }}?${queryString}`;
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Determine current view type
            const viewType = '{{ view_type }}';
            
            if (viewType === 'table') {
                updateTableView(result.data);
            } else if (viewType === 'card') {
                updateCardView(result.data);
            }
            
            // Update total items count
            const totalInfo = document.getElementById('total-items');
            if (totalInfo) {
                totalInfo.textContent = result.total_items + ' items';
            }
            
            // Update refresh time
            updateRefreshTimeDisplay();
            
            console.log(`Dashboard refreshed: ${result.total_items} items`);
        } else {
            console.error('Dashboard refresh failed:', result.error);
        }
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
    } finally {
        isRefreshing = false;
        showLoadingIndicator(false);
    }
}

// Start auto-refresh
function startAutoRefresh() {
    // Initial refresh time display
    updateRefreshTimeDisplay();
    
    // Clear any existing timer
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
    
    // Set up periodic refresh
    refreshTimer = setInterval(refreshDashboardData, REFRESH_INTERVAL);
    
    console.log(`Auto-refresh started: every ${REFRESH_INTERVAL/1000} seconds`);
}

// Stop auto-refresh (useful when page is hidden)
function stopAutoRefresh() {
    if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
    }
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        // Refresh immediately when page becomes visible
        refreshDashboardData();
        startAutoRefresh();
    }
});

// Initialize auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});

// Manual refresh button (optional - can be triggered by user)
function manualRefresh() {
    refreshDashboardData();
}

// Report Modal Functions
function openReportModal() {
    document.getElementById('reportModal').style.display = 'flex';
    // Set default to current month/year
    var now = new Date();
    document.getElementById('report_month').value = now.getMonth() + 1;
    document.getElementById('report_year').value = now.getFullYear();
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    var modal = document.getElementById('reportModal');
    if (e.target === modal) {
        closeReportModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeReportModal();
    }
});
</script>
{% endblock %}
