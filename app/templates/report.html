{% extends 'base.html' %} {% block content %}
<h2>Download Monthly Report</h2>

{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%} {% for category, message in messages %}
<div class="flash flash-{{ category }}">{{ message }}</div>
{% endfor %} {% endif %} {% endwith %}

<form method="post" class="form-report">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <div class="form-group">
    <label for="month">Month</label>
    <select name="month" id="month" required>
      {% for m in range(1, 13) %}
      <option value="{{ m }}" {% if month="" ="m" %}selected{% endif %}>
        {{ m }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="form-group">
    <label for="year">Year</label>
    <select name="year" id="year" required>
      {% for y in range(2020, 2031) %}
      <option value="{{ y }}" {% if year="" ="y" %}selected{% endif %}>
        {{ y }}
      </option>
      {% endfor %}
    </select>
  </div>
  <button type="submit">Download Excel</button>
  <a
    href="{{ url_for('report.report_preview') }}?month={{ month or 1 }}&year={{ year or 2026 }}"
    class="btn btn-secondary"
    >Preview</a
  >
</form>

{% if metrics %}
<h3>Preview: {{ month }}/{{ year }}</h3>
<div class="dashboard-table-wrapper">
  <table class="dashboard-table">
    <thead>
      <tr>
        <th>No</th>
        <th>Server</th>
        <th>IP</th>
        <th>Component</th>
        <th>Category</th>
        <th>Status</th>
        <th>Value</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody>
      {% for m in metrics %}
      <tr>
        <td>
          {{ (pagination.page - 1) * pagination.per_page + loop.index if
          pagination else loop.index }}
        </td>
        <td>{{ m.server_name }}</td>
        <td>{{ m.server_ip }}</td>
        <td>{{ m.component_name }}</td>
        <td>{{ m.category }}</td>
        <td><span class="status-{{ m.status|lower }}">{{ m.status }}</span></td>
        <td>{{ m.value }}</td>
        <td>{{ m.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8" class="text-center">No data found</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if pagination and pagination.pages > 1 %}
<div class="pagination">
  {% if pagination.has_prev %}
  <a
    href="{{ url_for('report.report_preview', month=month, year=year, page=pagination.prev_num) }}"
    class="btn btn-sm"
    >&laquo; Prev</a
  >
  {% endif %}

  <span class="page-info"
    >Page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total
    }} records)</span
  >

  {% if pagination.has_next %}
  <a
    href="{{ url_for('report.report_preview', month=month, year=year, page=pagination.next_num) }}"
    class="btn btn-sm"
    >Next &raquo;</a
  >
  {% endif %}
</div>
{% endif %} {% endif %} {% endblock %}
